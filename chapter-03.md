2.3.1 第一部分：关于去中心化的数据源预言机

这与区块链需要解决的问题非常相似，都是为了链下DOS实例在开放的拜占庭网络环境中就相同API调用的结果达成一致。来回顾下有关比特币中各种共识算法是如何工作的：实质上他们尝试在每一轮协议中，希望通过没有任何一方能够轻易垄断节点资源，去实现随机的领导者选举；只要大多数网络是可信的，区块链就会在概率意义上达成共识。生成公平、无偏倚的随机数对完成拜占庭容错（BFT）共识机制中尤为重要。我们主要通过利用可验证的随机函数（VRF）和阈值签名方案[25]来证明下面的链下共识协议。简单来说，我们不是在所有节点中进行领导者选举，而是在加载了各自协议的所有注册组中进行随机选择；通过采取阈值签名密码方案，只要超过 t（阈值）可信的，所选择的组就可以达到链下共识。

我们把“上一轮（即 i-1 轮）公布在链上的随机数为“ri-1”；每个注册的组都有具有相同的组大小（M）；并且，对于当前的 i 轮，有 T 个注册组。

组的注册和重组：新注册的节点首先进入待定状态，一旦待定池包含足够的待定节点并且等待了足够的时间，它们将被随机选择并组成新的阈值组。为了生成可信的多数组，同时处理"突发注册"的状况，待定的节点 M 应该转变到 k 折中，使每个折随机的分配到当前运行的组中，形成 k+1 这个新的注册组。为了消除自适应对手，每个组还有一个成熟期，也就是说几天之后这部分的组员会溶解到待定节点。然后在新注册的Gi 组的成员之间启动具有阈值t 的一次性非交互式 DKG 协议[26]（分布式密钥生成），因此：
将没有中央机构持有组密钥Gi, sk，并且保证在 Gi 的生命期内任何成员都不会透露Gi, sk。
每个成员 j 在可验证和去信任方式中将被分配一个Gi, sk  j组密钥。
生成组公钥 Gi, pk 并将其发布到链上的注册协议，更新已注册组的数量T = T + 1。

随机组选择：当前回合 i 的随机选择组将是：Gi=G[ri-1 mod T]。
通过 (t, n) 阈值签名方案形成群体共识：每个链下成员 j 处理查询请求并获得其对应的反馈Dj，成员 j 都用自己的组内密钥Gi, sk  j来作为签名Dj ，通过i, Dj  j = sign(Dj, Gi, sk  j) 将签名分享到其对等的阈值组Gi 内，同时等待组内其他成员的签名共享。这里应用 (t, n) 阈值签名方案意味着：需要至少 t 个成员有相同D 反馈签名额来生成有效的组签名 i, D，并且 t 个有效组签名额的任意组合可以组合成相同且确定性的 i, D，但是没有办法让少于 t 个成员生成有效的组签名。


验证和支付：成功结合组签名的第一个可信成员，将 i, D 提供给其对等节点，将{D, i, D}提供给区块链，并通过验证 verify(D, Gi, pk, i, D) 进行链上验证后接受其他可信成员在接收和验证组签名 i, D 时停止处理。理想状态下，区块链只有 1 个有效反馈，但是在多个可信节点同时反馈的情况下，只有第一个被验证的反馈将被链上代理系统接受，其他的将被省略。由于阈值组是随机选择的，一个DOS实例也可以属于多个组，只要DOS实例是分布式的，在一段时间内，每个实例被报告和被接受的机会将被转让。对已处理的阈值组查询请求的相关费用会被锁定在链上支付系统中，并且每天需要处理几次支付付款。处理费的10％用于交易费用报销池（见下节），阈值组将平分剩余部分。

成员权限管理/恶意成员处罚：恶意成员可以向区块链发送任意回复，但是，只要他们没有得到真正的查询回复，他们就不会通过链上验证，他们会被标记为没有权限，并被排除在未来的协议运行和付款流程之外。在这种情况下，他们的保证金也将被没收并转到交易费用报销池（见下节）

防止节点不劳而获：由于所有可信的成员分摊了费用，该算法内在的克服了“不劳而获”问题，即恶意节点仅监视系统协议的待处理事务，并且使用更高的Gas来解决待处理的事务，而不实际处理请求。此外，为了激励参与协议并提供较好的带宽/计算资源，每个组都会有质量评分：如果在某个超时时段内对所选组没有响应，则评级为负分，并选择后续组。具有异常正/负比率或负分数过高的组会被踢出协议，如果没有人参加，组内的所有成员都将失败。

Gas可持续性和交易费用报销池：以太坊的气体模型要求发起交易的节点支付Gas费用，包括由此产生的任何后续信息调用的费用。为了保证不可阻挡的、无偏见的、安全的随机数生成过程的可持续性，需要向可信的成员补偿响应数据、组签名和执行链上验证功能的Gas成本，因此需要在报销池内预留交易费用。最初的资金来自基金会捐赠和社区代币池，然而，随着网络的扩展和更多的用户合同依赖于DOS，将恶意节点10%的处理费用和没收的安全保证金存入报销池中，以备报销未来的交易费用。需要注意的是，用户自定义回调函数的执行也需要消耗Gas，但是不应该向节点实施者收取或报销Gas，因为回调函数的复杂性和Gas的消耗完全由调用协议决定，因此应该只由它们自己承担。调用协议能够设定Gas价格，他们需要确保他们有足够的余额来支付他们的回调功能的Gas。将金额托管在支付协议中，如果响应验证失败，它将返回调用协议，否则，将向节点传递支付成功的交付响应并通过验证。

非交互性和即时最终性：与pBFT（实用拜占庭容错算法）或其他基于节点通信的共识算法不同，这里不存在多轮消息传输。每个成员节点传输M大小消息，估计总大小为几 KB。也就是说，该算法是可扩展的，即使有几百个群组，所传输的消息的大小估计只有几 KB。此外，与PoW（工作量证明）/ PoS（权益证明）或其他基于资源的共识算法不同，这里最终确定性是即时的。(t, n)阈值签名的神奇之处在于任何 t 成员的有效签名共享都可以恢复相同的初始签名。

由于其独特的，确定性的，非交互式的，短签名以及参考资料[27]中提到的其他特征，所以BLS阈值签名方案是一个很好的候选者。

下一轮的随机性生成： Gi 组的每个成员  j 使用其组密钥Gi, sk  j，向对等组签名共享i, r  j = sign(last blockhash || ri-1, Gi, sk  j) 并应用相同的阈值签名方案来对 ri-1 进行签名)
只要一个成员收到任意成员 t 的有效签名共享，它就会将共享的签名组合成新的组签名i, r，因此，为下一轮生成的随机数可以是该组签名的哈希值： ri = H(i, r)，这无法预测，直到它生成并能在链上通过验证。
ri 在链上发布，并为下一轮协议加载选择阈值组 - 迭代将永远持续，这称为分布式随机引擎。



安全分析和协议增强：假设DOS总共有 N 个实例，拜占庭节点的数量为 B ，其中 N  3B + 1[28]。 阈值设置为t意味着组中至少需要 t 个成员才能达成共识。

将 P(k | M, B, N) 定义为从 N 个实例中随机抽样 M 个节点的概率，它们的精确值 k 是拜占庭节点。 从而：

 P(k | M, B, N) = CB k  CN-B M-kC N M;

它符合超几何概率分布[29]。 那么所选组反馈的拜占庭结果的概率是：

Pbyzantine result=P(kt | M, B, N);

对于可信成员来说，选择的组别不能达成共识的概率为：

Pno result=P(M-k <t | M, B, N) = P(kM-t+1 | M, B, N);

因此我们对结果的信心如下：

Pconfident =min 1-Pbyzantine result , 1-Pno result
                                         =minP(kt-1 | M,B,N),  P(kM-t | M,B,N);

当 t = ⌊M+12⌋ (M=2t-1) 时，对正确结果达成共识的概率最大：

Pconfident =P(kt-1 | M, B, N)=P(k<⌊M+12⌋ | M, B, N);
Pattack = 1-Pconfident;

使用在线计算器[30][31] ，结果显而易见：

N
B
Byzantine ratio
M
t
Pconfident
Pattack
1000
100
10.0%
21
11
99.999911%
8.900010-7
1000
150
15.0%
33
17
99.999943%
5.720010-7
1000
200
20.0%
49
25
99.999939%
6.130010-7
1000
250
25.0%
73
37
99.999923%
7.740010-7
1000
300
30.0%
115
58
99.999920%
8.010010-7
1000
333
33.3%
159
80
99.999905%
9.500010-7

基于以上观察我们提出几个协议更新如下:

网络规模：1000是一个非常合理的中短期估计：自2017年10月首次亮相后，ZenCash拥有约7000[32]个安全节点的网络，Smartcash仅在2018年1月31发布声明后的30天内，也拥有了8000[33] 个网络安全节点（masternodes）。在未来，我们预计DOS Network也会拥有数千个这样的实例。

最小化拜占庭比率：整个 DOS Network 的拜占庭比率在影响着系统安全 – 即便是这个比率略有下降，对我们信心增长也是很大的，利用可验证的阈值签名方案和恶意节点
惩罚，可以显著降低拜占庭比率。每个小组也有一个成熟期，以消除适应性对手。

最大化两种类别组的并行性：很明显，组网络规模越大， DOS Network的安全性就越大。但是，这又有一个两难的问题：组的规模越大，对数据提供者来说就越不友好 - 我们应该摆脱滥用DOS Network对数据源进行DDoS攻击的人。为了提供至少六个9（99.9999％，百万分之一的攻击率）的信心以及克服困难，将会存在两种阈值组：
一个是随机引擎组 - 由于组足够大且足够安全，例如159，仅通过生成无偏见和不可预测的随机数来驱动整个系统
另一个是工作组 - 处理实际查询的组，组大小限制为11~21，以防止数据提供者的资源被利用。
工作组由随机引擎组生成随机数r的哈希值与query_idj 一起选择：

Gworkerqueryj=Gworkers[H(ri-1 || query_idj) mod Tworkers ];

因此，将针对不同的查询工作选择不同的工作组，并且它们会被并行处理以实现最大的可扩展性。用户协议加工费的支付结构也需要调整：随机引擎组支付15%，工作组支付85%，每组按10/90的比例分配。
